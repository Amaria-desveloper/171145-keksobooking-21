(()=>{"use strict";window.constants={QUANTITY_PINS:5,TYPES:{flat:"Квартира",house:"Дом",palace:"Дворец",bungalow:"Бунгало"},CAPACITY:["для 1 гостя","для 2 гостей","для 3 гостей","не для гостей"],TIME_IN:["12:00","13:00","14:00"],FEATURES:["wifi","dishwasher","parking","washer","elevator","conditioner"],DEPENCE_ROOM_GUESTS:{1:[1],2:[1,2],3:[1,2,3],100:[0]},TYPE_MIN_PRICE:{palace:"10000",flat:"1000",house:"5000",bungalow:"0"}},window.variables={map:{map:document.querySelector(".map"),mapPins:document.querySelector(".map__pins"),mapPin:document.querySelector(".map__pin"),mapPinMain:document.querySelector(".map__pin--main"),mapFilter:document.querySelector(".map__filters")},form:{adForm:document.querySelector(".ad-form"),adFormFieldset:document.querySelectorAll(".ad-form fieldset"),adFormAddress:document.querySelector("#address"),adFormAvatar:document.querySelector("#avatar"),adFormType:document.querySelector("#type"),adFormPrice:document.querySelector("#price"),adFormCapacity:document.querySelector("#capacity"),adFormImages:document.querySelector("#images"),adFormRoomNumber:document.querySelector("#room_number")}},(()=>{const e={getWidth:e=>e.offsetWidth,getHeight:e=>e.offsetHeight},t=e=>parseInt(e.style.top,10),o=e=>parseInt(e.style.left,10);window.util={sizeOfElement:e,getOffset:t=>({x:parseInt(e.getWidth(t)/2,10),y:parseInt(e.getHeight(t)/2,10)}),findElement:(e,t)=>e[t]||"",getCoordinateOfPinMain:()=>{let r=document.querySelector(".map__pin--main");const n=window.getComputedStyle(r,"::after"),a=parseInt(n.getPropertyValue("border-top-width"),10);return[Math.floor(o(r)+e.getWidth(r)/2)+", "+Math.floor(t(r)+e.getHeight(r)+a/2)]},getCoordinateCenterOfPinMain:r=>[o(r)+e.getWidth(r)/2+", "+(t(r)+Math.floor(e.getHeight(r)/2))],closeElement:e=>e.remove(),makeDisabled:{set:e=>{for(let t=0;t<e.length;t++)e[t].setAttribute("disabled",!0)},remove:e=>{for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled",!0)}},modalLayout:e=>{const t=document.createElement("div");t.id="modal",t.style="z-index: 100; display: flex; justify-content: center; min-height: 50px; margin: auto; padding: 15px; background-color: white; border: 2px solid SkyBlue; border-radius: 10px",t.style.position="fixed",t.style.left=0,t.style.right=0,t.style.fontSize="26px";const o=document.createElement("p");o.style="display: inherit",o.textContent=e;const r=document.createElement("button");return r.id="modalButton",r.style="display: block; width: 40px; height: 20px; border-radius: 4px; border-color: SkyBlue; background-color: seashell; outline-color: SkyBlue",r.style.position="absolute",r.style.bottom="2px",r.style.fontSize="12px",r.textContent="OK",t.appendChild(o),t.appendChild(r),t},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}}})(),(()=>{const e=window.variables.map.mapFilter,t=e.querySelector('select[name="housing-type"]'),o=e.querySelector('.map__filters select[name="housing-price"]'),r=e.querySelector('.map__filters select[name="housing-rooms"]'),n=e.querySelector('.map__filters select[name="housing-guests"]');window.filter={makeFilter:a=>{const i=()=>{let t=e.querySelectorAll('.map__filters .map__features input[name="features"]:checked'),o=[];return Array.from(t).map((e=>{o.push(e.value)})),o};let s=(()=>{let e={type:t.value,price:{min:0,max:1/0},rooms:"",guests:"",features:i()};return"any"===t.value&&(e.type=""),"any"!==o.value&&("low"===o.value?e.price.max=1e4:"middle"===o.value?(e.price.min=1e4,e.price.max=5e4):e.price.min=5e4),"any"!==r.value&&(e.rooms=Number(r.value,0)),"any"!==n.value&&(e.guests=Number(n.value,0)),e})();return a.filter((e=>{let t=e.offer.type===s.type||""===s.type,o=e.offer.price>=s.price.min&&e.offer.price<s.price.max,r=e.offer.rooms===s.rooms||""===s.rooms,n=e.offer.guests===s.guests||""===s.guests,a=s.features.every((t=>e.offer.features.includes(t)));return t&&o&&r&&n&&a}))}}})(),(()=>{const e=window.util.findElement,t=window.util.closeElement,o=window.constants.TYPES,r=window.constants.FEATURES,n=document.querySelector("#card").content.querySelector(".map__card");window.card={setupCard:(a,i)=>{let s=n.cloneNode(!0);if(s.querySelector(".popup__avatar").src=a.author.avatar,s.querySelector(".popup__title").textContent=a.offer.title,s.querySelector(".popup__text--address").textContent=a.offer.address,s.querySelector(".popup__text--price").textContent=a.offer.price+" ₽/ночь",s.querySelector(".popup__type").textContent=e(o,a.offer.type),s.querySelector(".popup__text--capacity").textContent=`Комнат: ${a.offer.rooms}, кол-во спальных мест: ${a.offer.guests}`,s.querySelector(".popup__text--time").textContent=`Заезд после ${a.offer.checkin}, выезд до ${a.offer.checkout}`,r.filter((e=>{a.offer.features.includes(e)||s.querySelector(".popup__feature--"+e).remove()})),s.querySelector(".popup__description").textContent=a.offer.description,0===a.offer.photos.length)s.querySelector(".popup__photo").setAttribute("style","visibility: hidden;");else if(s.querySelector(".popup__photo").src=a.offer.photos[0],a.offer.photos.length>1)for(let e=1;e<a.offer.photos.length;e++){let t=document.createElement("img");t.classList.add("popup__photo"),t.src=a.offer.photos[e],t.width="45",t.height="40",t.alt="Фотография жилья",s.querySelector(".popup__photos").appendChild(t)}return s.querySelector(".popup__close").addEventListener("click",(function(){t(s),i.classList.remove("map__pin--active")})),document.addEventListener("keydown",(function e(o){"Escape"===o.key&&(o.preventDefault(),t(s)),document.removeEventListener("keydown",e)})),s},removeCard:()=>{const e=document.querySelector(".map__card");e&&t(e)}}})(),(()=>{const e=window.util.closeElement,t=window.util.debounce,o=window.filter.makeFilter,r=window.card.setupCard,n=window.card.removeCard,a=window.constants.QUANTITY_PINS,i=window.variables.map.mapPins,s=window.variables.map.mapFilter,d=document.querySelector("#pin").content.querySelector(".map__pin"),l=(e,t)=>{let o=d.cloneNode(!0);return o.querySelector("img").src=e[t].author.avatar,o.querySelector("img").alt=e[t].offer.title,o.style.left=e[t].location.x+"px",o.style.top=e[t].location.y+"px",o.addEventListener("click",(function(){c(e[t],o)})),o},c=function(t,o){let n=document.querySelector(".map__card");null!==n&&e(n),i.querySelector(".map__pin--active")&&i.querySelector(".map__pin--active").classList.remove("map__pin--active"),o.classList.add("map__pin--active"),i.append(r(t,o))},u=(e,t)=>{let o=document.createDocumentFragment();for(let r=0;r<t;r++)o.appendChild(l(e,r));return o},m=e=>{let t=[];for(let o=0;o<e.length;o++)void 0!==e[o].offer&&t.push(e[o]);return t},p=()=>{let t=i.querySelectorAll(".map__pin:not(.map__pin--main)");for(let o of t)e(o)};window.pin={renderPins:u,removeCurrentPins:p,generateAvailablePins:m,addPinOnMap:e=>{let r=m(e),d=r.reverse();i.append(u(d,a)),s.addEventListener("change",t((function(){p(),n();let e=o(r),t=e.length;t<a?i.append(u(e,t)):i.append(u(e,a))})))}}})(),(()=>{const e=window.util.closeElement,t=window.pin.addPinOnMap,o=window.util.modalLayout,r=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error"),a=()=>{let t=document.querySelector(".success"),o=document.querySelector(".error");o&&e(o),t&&e(t),document.removeEventListener("click",a),document.removeEventListener("keydown",i)},i=function(e){"Escape"===e.key&&(e.preventDefault(),a())},s=(e,t)=>{const o=e.cloneNode(!0);e===n&&(o.querySelector(".error__message").textContent=t),document.body.insertAdjacentElement("afterbegin",o),o.tabIndex=0,o.focus()};window.notices={errorDataHandler:t=>{document.body.insertAdjacentElement("afterbegin",o(t));const r=document.querySelector("#modal"),n=document.querySelector("#modalButton");n.focus(),n.addEventListener("click",(function(t){t.preventDefault(),e(r)})),document.addEventListener("keydown",(function t(o){"Escape"===o.key&&(o.preventDefault(),e(r)),document.removeEventListener("keydown",t)}))},sendIsSuccess:()=>{s(r),window.main.restartPage(),document.addEventListener("click",a),document.addEventListener("keydown",i)},sendIsError:e=>{s(n,e),document.querySelector(".error").querySelector(".error__button").addEventListener("click",a),document.addEventListener("keydown",i)},successDataHandler:e=>{t(e)}}})(),(()=>{const e=function(e,t,o,r,n){const a=new XMLHttpRequest;return a.responseType="json",a.timeout=1e4,a.open(o,r),a.send(n),a.addEventListener("load",(function(){let o="";switch(a.status){case 200:e(a.response);break;case 400:o="Неверный запрос";break;case 404:o="Ничего не найдено. (По этому URL пусто)";break;case 500:o="Сервис сломался, попробуйте позже";break;default:t(`Статус ответа: ${a.status} ${a.statusText}`)}o&&t(o)})),a.addEventListener("error",(function(){t("Произошла ошибка соединения")})),a.addEventListener("timeout",(function(){t("Запрос не успел выполниться за 10000 мс")})),a};window.backend={load:function(t,o){e(t,o,"GET","https://21.javascript.pages.academy/keksobooking/data")},save:function(t,o,r){e(t,o,"POST","https://21.javascript.pages.academy/keksobooking",r)}}})(),(()=>{const e=window.constants.TYPE_MIN_PRICE,t=window.backend.save,o=window.notices.sendIsSuccess,r=window.notices.sendIsError,n=window.variables.form.adForm,a=window.variables.form.adFormAvatar,i=window.variables.form.adFormType,s=window.variables.form.adFormPrice,d=window.variables.form.adFormCapacity,l=window.variables.form.adFormImages,c=document.querySelector("#title"),u=window.variables.form.adFormRoomNumber,m=window.constants.DEPENCE_ROOM_GUESTS,p=(e,t,o,r,n)=>{e?(n.setCustomValidity(t),n.reportValidity()):o?(n.setCustomValidity(r),n.reportValidity()):n.setCustomValidity("")},f=function(e){_(e.target.value,e.target,d)},w=function(e){p(e.target.value.length<30,"Заголовок объявления должен быть больше 30 символов",e.target.value.length>100,"Заголовок объявления должен быть меньше 100 символов",c)},v=function(e){window.form.showAvatarPreview(e.target)},y=function(e){window.form.showImagesPreview(e.target)},g=function(e){h(e.target.value,s)},h=(t,o)=>{o.setAttribute("min",e[t]),o.placeholder=e[t],s.addEventListener("blur",(function(o){o.preventDefault(),p(s.value<e[t]||"","Цена не менее "+e[t],i.value>1e6,"Цена не более 1 000 000",s)}))},_=(e,t,o)=>{var r,n,a;r=m[e].includes(Number(o.value),0),n="выберите допустимое количество гостей",a=o,r?a.setCustomValidity(""):(a.setCustomValidity(n),a.reportValidity()),t.querySelector(`option[value="${e}"`).setAttribute("selected","true");for(let e=0;e<o.length;e++)o[e].setAttribute("style","display: none");m[e].forEach((e=>{o.querySelector(`option[value="${e}"]`).setAttribute("style","display: auto")})),d.addEventListener("change",(function(r){r.target.querySelector(`option[value="${r.target.value}"]`).setAttribute("selected","true"),_(e,t,o)}))};n.addEventListener("submit",(function(e){t(o,r,new FormData(n)),e.preventDefault()})),window.validateForm={validate:()=>{u.addEventListener("change",f),c.addEventListener("input",w),i.addEventListener("change",g),a.addEventListener("change",v),l.addEventListener("change",y)}}})(),(()=>{const e=window.constants.TYPE_MIN_PRICE,t=window.util.closeElement,o=window.variables.form.adForm,r=window.variables.form.adFormAddress,n=window.variables.form.adFormAvatar,a=window.variables.form.adFormType,i=window.variables.form.adFormPrice,s=window.variables.form.adFormCapacity,d=window.variables.form.adFormImages,l=window.variables.form.adFormRoomNumber,c=document.querySelector("#timein"),u=document.querySelector("#timeout"),m=document.querySelector(".ad-form-header__preview img"),p=document.querySelector(".ad-form__photo"),f=document.querySelector(".ad-form__photo-container"),w=document.querySelector(".ad-form__reset");var v,y;y=u,(v=c).addEventListener("change",(function(){y.value=v.value})),y.addEventListener("change",(function(){v.value=y.value}));const g=e=>{e.reset(),(()=>{const e=f.querySelectorAll("img"),o=f.querySelectorAll(".ad-form__photo");for(let o of e)t(o);for(let e=1;e<o.length;e++)t(o[e]);m.src="img/muffin-grey.svg"})(),l.selectedIndex=0,s.selectedIndex=0};w.addEventListener("click",(function(e){e.preventDefault(),g(o),window.main.restartPage()})),window.form={setAddressValue:(e,t)=>{e.value=t},installDefaultForm:()=>{for(let e=1;e<s.length;e++)s[e].setAttribute("style","display: none");r.setAttribute("style","color: brown"),r.setAttribute("readonly","true"),i.placeholder="1000",i.setAttribute("min",e[a.value]),i.setAttribute("max","1000000"),n.setAttribute("accept","image/*"),d.setAttribute("accept","image/*"),d.multiple=!0},showAvatarPreview:e=>{m.src=URL.createObjectURL(e.files[0])},showImagesPreview:e=>{let t=document.createElement("img");if(t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.src=URL.createObjectURL(e.files[0]),p.appendChild(t),e.files.length>1){let o=document.createDocumentFragment();for(let r=1;r<e.files.length;r++){let n=p.cloneNode(!0);t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.src=URL.createObjectURL(e.files[r]),o.appendChild(n)}f.appendChild(o)}},formReset:g}})(),(()=>{const e=window.variables.map.mapPinMain,t=window.variables.map.map,o=window.util.sizeOfElement.getWidth,r=window.util.getOffset,n=window.form.setAddressValue,a=r(e).x,i={TOP:130,BOTTOM:630,left:0-a,right:o(t)-a},s=(t,o,r,n)=>{e.style[t]=o<r?r+"px":o>n?n+"px":o+"px"};window.dragPinMain=function(t){t.preventDefault();let o={x:t.clientX,y:t.clientY};const r=function(t){t.preventDefault();const r=o.x-t.clientX,n=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const a={x:e.offsetLeft-r,y:e.offsetTop-n};s("left",a.x,i.left,i.right),s("top",a.y,i.TOP,i.BOTTOM)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",(function e(t){t.preventDefault();const o=window.variables.form.adFormAddress,a=window.util.getCoordinateOfPinMain();n(o,a),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",e)}))}})(),(()=>{const e=window.util.getCoordinateCenterOfPinMain,t=window.util.makeDisabled,o=window.backend.load,r=window.notices.successDataHandler,n=window.notices.errorDataHandler,a=window.card.removeCard,i=window.dragPinMain,s=window.form.formReset,d=window.form.installDefaultForm,l=window.form.setAddressValue,c=window.validateForm.validate,u=window.variables.map.map,m=window.variables.map.mapPinMain,p=window.variables.form.adForm,f=window.variables.form.adFormFieldset,w=window.variables.form.adFormAddress,v=document.querySelectorAll(".map__filters fieldset"),y=document.querySelectorAll(".map__filters select"),g={left:m.style.left,top:m.style.top};window.map={setInactive:()=>{u.classList.add("map--faded"),p.classList.add("ad-form--disabled"),s(p),t.set(f),t.set(v),t.set(y),a(),m.style.left=g.left,m.style.top=g.top,l(w,e(m))},makeWork:()=>{m.addEventListener("click",(function e(a){a.preventDefault(),d(),c(),u.classList.remove("map--faded"),p.classList.remove("ad-form--disabled"),t.remove(f),t.remove(v),t.remove(y),o(r,n),m.addEventListener("mousedown",i),m.removeEventListener("click",e)}))}}})(),(()=>{const e=window.pin.removeCurrentPins,t=window.map.setInactive,o=window.map.makeWork,r=()=>{t(),o()};r(),window.main={restartPage:()=>{e(),r()}}})()})();